<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WarpSpeed - AI Sprint Planner</title>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Jira-like Dark Mode Palette */
            --bg-body: #1D1F23;
            --bg-sidebar: #16181C;
            --bg-card: #282A30;
            --bg-card-hover: #31333A;
            --border-color: #3B3E45;
            --text-primary: #ECECF0;
            --text-secondary: #8C919C;
            --text-tertiary: #6B778C;

            --accent-primary: #577BF9;
            /* Jira Blue-ish */
            --accent-hover: #4568E0;
            --success: #36B37E;
            --warning: #FFAB00;
            --danger: #FF5630;
            --info: #00B8D9;

            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            --header-height: 60px;
            --sidebar-width: 260px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            font-size: 14px;
        }

        /* --- Global Utility --- */
        .icon {
            width: 16px;
            height: 16px;
            /* Missing flex-shrink: 0 as per V2 state */
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .btn {
            border: none;
            border-radius: 4px;
            /* Jira style is slightly sharper */
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .btn-sm {
            font-size: 12px;
            padding: 4px 8px;
        }

        .tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            text-transform: uppercase;
        }

        .avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            border: 2px solid var(--bg-card);
        }

        /* --- Landing Page --- */
        #view-landing {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-body);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        .landing-card {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 400px;
            text-align: center;
        }

        .landing-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-body);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: white;
            margin: 20px 0;
            font-family: inherit;
        }

        /* --- App Layout --- */
        #app-wrapper {
            display: flex;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s;
            pointer-events: none;
        }

        #app-wrapper.visible {
            opacity: 1;
            pointer-events: all;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: var(--spacing-lg) 12px;
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 32px;
            padding-left: 8px;
        }

        .nav-item {
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: 4px;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(87, 123, 249, 0.1);
            color: var(--accent-primary);
        }

        .nav-item.active svg {
            color: var(--accent-primary);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            height: var(--header-height);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-lg);
            background: var(--bg-body);
        }

        select.dropdown {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 500;
            outline: none;
            min-width: 200px;
        }

        /* --- Views --- */
        .view-container {
            display: none;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .view-container.active {
            display: flex;
        }

        /* Sprint Board */
        .board-layout {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .backlog-col {
            flex: 2;
            padding: var(--spacing-lg);
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }

        .ai-col {
            flex: 1;
            min-width: 350px;
            background: #181A1F;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
        }

        .sprint-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
            position: relative;
        }

        .sprint-item:hover {
            background: var(--bg-card-hover);
            transform: translateX(2px);
        }

        .item-actions {
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            gap: 4px;
        }

        .sprint-item:hover .item-actions {
            opacity: 1;
        }

        /* Progress / Kanban */
        .kanban-board {
            display: flex;
            gap: 16px;
            padding: 24px;
            height: 100%;
            overflow-x: auto;
            width: 100%;
        }

        .kanban-col {
            flex: 1;
            min-width: 280px;
            max-width: 350px;
            background: var(--bg-sidebar);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .kanban-header {
            padding: 12px 16px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }

        .kanban-body {
            padding: 12px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .kanban-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: 4px;
            cursor: grab;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .progress-bar {
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.5s;
        }

        /* People / Graph View */
        .graph-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: radial-gradient(circle at 50% 50%, rgba(87, 123, 249, 0.05) 0%, transparent 70%);
        }

        .node {
            position: absolute;
            width: 120px;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--accent-primary);
            border-radius: 8px;
            text-align: center;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 2;
        }

        .node h4 {
            margin: 0 0 4px 0;
            font-size: 13px;
        }

        .node p {
            margin: 0;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .connection-line {
            position: absolute;
            height: 2px;
            background: #3B3E45;
            transform-origin: 0 50%;
            z-index: 1;
        }

        /* Chat */
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
        }

        .chat-bubble.user {
            align-self: flex-end;
            background: var(--accent-primary);
            color: white;
        }

        .chat-bubble.ai {
            align-self: flex-start;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        /* Helpers */
        .hidden {
            display: none !important;
        }

        .editable {
            border-bottom: 1px dashed var(--text-secondary);
            cursor: text;
        }

        .editable:focus {
            border-bottom: 1px solid var(--accent-primary);
            outline: none;
            color: white;
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
        }

        .dash-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .dash-card h4 {
            margin: 0 0 15px 0;
            color: var(--text-secondary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .kpi-sub {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .signal-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .signal-item:last-child {
            border-bottom: none;
        }

        .signal-tag {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            background: rgba(87, 157, 255, 0.15);
            color: #579DFF;
            font-weight: 500;
        }

        /* Enhanced Graph Styles */
        .graph-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: radial-gradient(circle at center, #1b212b 0%, var(--bg-body) 70%);
        }

        .node {
            position: absolute;
            transition: transform 0.05s linear;
            cursor: pointer;
            user-select: none;
        }

        .node-person {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-card-hover);
            border: 2px solid var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .node-agent {
            width: 54px;
            height: 54px;
            /* Hexagon Shape */
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            background: linear-gradient(135deg, #0052CC, #1e2530);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            font-size: 24px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 82, 204, 0.4);
        }

        .node-task {
            width: 140px;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            z-index: 5;
            font-size: 11px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border-left: 3px solid var(--accent-primary);
        }

        .node-label {
            position: absolute;
            top: 100%;
            width: 120px;
            text-align: center;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-top: 8px;
            pointer-events: none;
        }

        svg.graph-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        line.connection {
            stroke: var(--border-color);
            stroke-width: 1.5px;
            opacity: 0.6;
        }

        line.collaboration {
            stroke: var(--accent-primary);
            stroke-width: 2px;
            opacity: 0.3;
        }

        line.dependency {
            stroke: var(--danger);
            stroke-width: 1.5px;
            stroke-dasharray: 4 4;
            opacity: 0.8;
        }

        /* Sidebar Member Cards */
        .member-card {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            margin-bottom: 8px;
        }

        .member-card:hover {
            border-color: var(--text-secondary);
        }
    </style>
</head>

<body>

    <!-- LANDING VIEW -->
    <div id="view-landing">
        <div class="landing-card">
            <div style="display:flex; justify-content:center; margin-bottom: 24px;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="#577BF9">
                    <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <h1 style="margin:0 0 8px 0; font-size: 24px;">Welcome to WarpSpeed</h1>
            <p style="color:var(--text-secondary); margin:0 0 24px 0;">AI-First Engineering Management</p>

            <input type="email" class="landing-input" placeholder="Enter company email (e.g. manager@acme.com)"
                value="em@acme.corp" />

            <button class="btn btn-primary" style="width:100%; justify-content:center; height: 44px;"
                onclick="app.login()">
                Enter Workspace
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-wrapper">
        <nav class="sidebar">
            <div class="logo">
                <svg class="icon" style="width:20px;height:20px;color:var(--accent-primary)">
                    <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                WarpSpeed
            </div>

            <div class="nav-item active" onclick="app.nav('plan')" id="nav-plan">
                <svg class="icon">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Sprint Plan
            </div>
            <div class="nav-item" onclick="app.nav('kanban')" id="nav-kanban">
                <svg class="icon">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <rect x="7" y="7" width="3" height="9"></rect>
                    <rect x="14" y="7" width="3" height="5"></rect>
                </svg>
                Progress Tracker
            </div>
            <div class="nav-item" onclick="app.nav('people')" id="nav-people">
                <svg class="icon">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                Team & Agents
            </div>
            <div class="nav-item" onclick="app.nav('data')" id="nav-data">
                <svg class="icon">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                Data Inspector
            </div>

            <div style="margin-top:auto">
                <div class="nav-item"><svg class="icon">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg> Settings</div>
            </div>
        </nav>

        <div class="main-content">
            <header>
                <div style="display:flex; align-items:center;">
                    <span style="color:var(--text-secondary); margin-right:12px;">Scenario:</span>
                    <select id="scenario-dropdown" class="dropdown" onchange="app.setScenario(this.value)">
                        <option value="MAIN">Sprint 24 (Standard)</option>
                        <option value="PTO">‚ö†Ô∏è Capacity Shock (PTO)</option>
                        <option value="FLAKY">üî• Flaky Test Spike</option>
                        <option value="DEPENDENCY">üß± Dependency Risk</option>
                    </select>
                </div>
                <div style="display:flex; align-items:center; gap:12px">
                    <div style="text-align:right">
                        <div style="font-weight:600; font-size:13px;">Rahul (EM)</div>
                        <div style="font-size:11px; color:var(--text-secondary)">Engineering Manager</div>
                    </div>
                    <div class="avatar" style="background:#0052CC">RA</div>
                </div>
            </header>

            <!-- VIEW: PLAN -->
            <div id="view-plan" class="view-container active">
                <div class="board-layout">
                    <div class="backlog-col">
                        <div style="display:flex; justify-content:space-between; margin-bottom: 24px;">
                            <h2 style="margin:0; font-size:20px;">Good Morning! Here's the plan for Sprint 24:</h2>
                            <div style="display:flex; gap:16px;">
                                <div class="tag"
                                    style="background:rgba(54, 179, 126, 0.1); color:#36B37E; height:24px; display:flex; align-items:center;">
                                    Confidence: <span id="kpi-confidence" style="margin-left:4px">88%</span></div>
                                <div class="tag" style="height:24px; display:flex; align-items:center;">Capacity: <span
                                        id="kpi-capacity" style="margin-left:4px">--</span></div>
                            </div>
                        </div>

                        <div id="plan-items"></div>

                        <div style="margin-top:40px; text-align:right;">
                            <button class="btn btn-primary" onclick="app.approveSprint()">Approve Sprint Start
                                &rarr;</button>
                        </div>
                    </div>
                    <div class="ai-col">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); font-weight:600;">
                            WarpSpeed Assistant</div>
                        <div class="chat-history" id="chat-history">
                            <div class="chat-bubble ai">
                                I've drafted Sprint 24. I matched Arjun to the critical Payment fix.
                            </div>
                        </div>
                        <div style="padding:16px; border-top:1px solid var(--border-color);">
                            <input type="text" id="chat-input" class="landing-input"
                                style="margin:0; padding-right:8px;" placeholder="How can I help you?"
                                onkeypress="app.chatKey(event)" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: KANBAN -->
            <div id="view-kanban" class="view-container">
                <div class="kanban-board">
                    <div class="kanban-col">
                        <div class="kanban-header">To Do <span id="count-todo">0</span></div>
                        <div class="kanban-body" id="col-todo"></div>
                    </div>
                    <div class="kanban-col">
                        <div class="kanban-header">In Progress <span id="count-progress">0</span></div>
                        <div class="kanban-body" id="col-progress"></div>
                    </div>
                    <div class="kanban-col">
                        <div class="kanban-header">Done <span id="count-done">0</span></div>
                        <div class="kanban-body" id="col-done"></div>
                    </div>
                </div>
            </div>

            <!-- VIEW: PEOPLE & GRAPH -->
            <div id="view-people" class="view-container">
                <div style="display:flex; height:100%;">
                    <div
                        style="width:300px; border-right:1px solid var(--border-color); padding:24px; overflow-y:auto;">
                        <h3>Team & Agents</h3>
                        <div id="people-list"></div>
                    </div>
                    <div style="flex:1; position:relative;" id="graph-area">
                        <!-- SVG Layer -->
                        <svg id="graph-svg" style="width:100%; height:100%"></svg>
                        <!-- Nodes appended here by JS -->
                    </div>
                </div>
            </div>

            <!-- VIEW: DATA -->
            <div id="view-data" class="view-container">
                <div id="data-content"
                    style="padding:40px; max-width:1200px; margin:0 auto; width:100%; height:100%; overflow-y:auto;">
                    <!-- Rendered by app.renderData() -->
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- DATA ENGINE ---
        const MEMBERS = [
            { id: 'u1', name: 'Arjun', role: 'Staff Eng', avatar: 'AR' },
            { id: 'u2', name: 'Priya', role: 'Backend', avatar: 'PR' },
            { id: 'u3', name: 'Rohan', role: 'Frontend', avatar: 'RO' },
            { id: 'u4', name: 'Sneha', role: 'QA', avatar: 'SN' },
            { id: 'a1', name: 'Agent: Flaky', role: 'AI Agent', type: 'AI', avatar: 'FL' },
            { id: 'a2', name: 'Agent: DepCheck', role: 'AI Agent', type: 'AI', avatar: 'DC' },
        ];

        let STATE = {
            view: 'landing', // landing, plan, kanban, people, data
            scenario: 'MAIN',
            plan: [],
            backlog: [],
            confidence: 88,
            chatHistory: []
        };

        // Seed Data
        const RAW_BACKLOG = [
            { id: 'T-101', title: 'Implement Auth0 SSO', points: 5, priority: 'High', status: 'To Do', assignee: 'u1' },
            { id: 'T-102', title: 'Fix Race Condition', points: 8, priority: 'Critical', status: 'In Progress', assignee: 'u2' },
            { id: 'T-103', title: 'Dashboard Redesign', points: 3, priority: 'Medium', status: 'To Do', assignee: 'u3' },
            { id: 'T-104', title: 'Optimize DB Query', points: 5, priority: 'Low', status: 'To Do', assignee: 'u2' },
            { id: 'T-105', title: 'Flaky Checkout Test', points: 3, priority: 'High', status: 'In Progress', assignee: 'a1' },
            { id: 'T-106', title: 'API Rate Limiting', points: 8, priority: 'High', status: 'To Do', assignee: 'u1' },
        ];

        // --- CONTROLLER ---
        const app = {
            login: () => {
                document.getElementById('view-landing').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('view-landing').style.display = 'none';
                    document.getElementById('app-wrapper').classList.add('visible');
                    app.init();
                }, 500);
            },

            init: () => {
                app.setScenario('MAIN');
            },

            nav: (view) => {
                // Update UI State
                document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${view}`).classList.add('active');

                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navId = `nav-${view}`;
                if (document.getElementById(navId)) document.getElementById(navId).classList.add('active');

                STATE.view = view;
                if (view === 'kanban') app.renderKanban();
                if (view === 'people') app.renderPeopleGraph();
                if (view === 'data') app.renderData();
            },

            setScenario: (scen) => {
                STATE.scenario = scen;
                // Generate Logic
                let items = JSON.parse(JSON.stringify(RAW_BACKLOG));
                let conf = 88;

                if (scen === 'PTO') {
                    // Drop items assigned to u1 (Arjun) or u2 (Priya) roughly
                    items = items.filter(i => i.id !== 'T-101' && i.id !== 'T-106');
                    conf = 72;
                } else if (scen === 'FLAKY') {
                    items.unshift({ id: 'T-999', title: 'URGENT: Blocked CI', points: 5, priority: 'Critical', assignee: 'a1', status: 'In Progress' });
                    conf = 60;
                } else if (scen === 'DEPENDENCY') {
                    items = items.filter(i => i.id !== 'T-101'); // No SSO
                    conf = 80;
                }

                STATE.plan = items;
                STATE.confidence = conf;
                app.renderPlan();
            },

            // --- RENDERERS ---
            renderPlan: () => {
                const el = document.getElementById('plan-items');
                el.innerHTML = '';
                document.getElementById('kpi-confidence').innerText = STATE.confidence + '%';

                // Add Summary and Link
                const header = document.querySelector('.backlog-col h2');
                // Remove existing summary if any (idempotency)
                if (header.nextElementSibling && header.nextElementSibling.classList.contains('plan-summary')) {
                    header.nextElementSibling.remove();
                }
                const summary = document.createElement('div');
                summary.className = 'plan-summary';
                summary.style.marginBottom = '20px';

                header.parentNode.insertBefore(summary, header.nextSibling);

                STATE.plan.forEach(item => {
                    const mem = MEMBERS.find(m => m.id === item.assignee) || { name: 'Unassigned' };
                    const isAi = mem.type === 'AI';

                    let pColor = '#8C919C';
                    if (item.priority === 'Critical') pColor = '#FF5630';
                    if (item.priority === 'High') pColor = '#FFAB00';

                    const div = document.createElement('div');
                    div.className = 'sprint-item';
                    div.innerHTML = `
                        <div style="display:flex; gap:12px; align-items:center;">
                            <div style="color:${pColor}"><svg class="icon"><circle cx="8" cy="8" r="6"></circle></svg></div>
                            <div>
                                <div style="font-weight:500; font-size:15px; margin-bottom:4px;">${item.title}</div>
                                <div style="font-size:12px; color:var(--text-secondary); display:flex; gap:8px;">
                                    <span>${item.id}</span>
                                    <span>${item.points} pts</span>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:16px;">
                            <div class="tag" style="background:rgba(255,255,255,0.05); text-transform:none; font-weight:400; display:flex; gap:6px; align-items:center; padding:4px 10px;">
                                ${isAi ? 'ü§ñ' : 'üë§'} ${mem.name}
                            </div>
                            <div class="item-actions">
                                <button class="btn btn-sm" onclick="app.actionItem('${item.id}', 'ignore')">Ignore</button>
                                <button class="btn btn-sm" onclick="app.actionItem('${item.id}', 'weight')">+Weight</button>
                            </div>
                        </div>
                    `;
                    el.appendChild(div);
                });
            },

            renderKanban: () => {
                ['todo', 'progress', 'done'].forEach(k => document.getElementById(`col-${k}`).innerHTML = '');

                STATE.plan.forEach(item => {
                    let col = 'todo';
                    if (item.status === 'In Progress') col = 'progress';
                    if (item.status === 'Done') col = 'done';

                    const mem = MEMBERS.find(m => m.id === item.assignee);

                    const card = document.createElement('div');
                    card.className = 'kanban-card';
                    // Progress bar simulation based on status
                    let pct = 0;
                    if (item.status === 'In Progress') pct = Math.floor(Math.random() * 60) + 20;
                    if (item.status === 'Done') pct = 100;

                    card.innerHTML = `
                        <div style="font-size:13px; font-weight:500; margin-bottom:8px;">${item.title}</div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="tag">${item.id}</span>
                            <div class="avatar" style="width:20px; height:20px; font-size:9px;">${mem ? mem.avatar : '?'}</div>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                    `;
                    document.getElementById(`col-${col}`).appendChild(card);
                });
            },

            renderPeopleGraph: () => {
                const area = document.getElementById('graph-area');
                area.innerHTML = `
                    <svg class="graph-lines"></svg>
                    <div id="nodes-container"></div>
                    <div style="position:absolute; bottom:20px; right:20px; background:var(--bg-card); border:1px solid var(--border-color); padding:12px; border-radius:8px; z-index:100; font-size:11px; box-shadow:0 4px 12px rgba(0,0,0,0.3);">
                        <div style="font-weight:600; margin-bottom:8px; color:var(--text-secondary);">Legend</div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <div style="width:12px; height:12px; border-radius:50%; border:2px solid var(--accent-primary); background:var(--bg-card-hover);"></div>
                            <span>Team Member</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <div style="width:12px; height:12px; background:linear-gradient(135deg, #0052CC, #1e2530); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);"></div>
                            <span>AI Agent</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <div style="width:16px; height:10px; border:1px solid var(--border-color); border-left:3px solid var(--accent-primary); background:var(--bg-card); border-radius:2px;"></div>
                            <span>Task</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <div style="width:20px; height:2px; background:var(--accent-primary); opacity:0.5;"></div>
                            <span>Collaboration</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="width:20px; height:0; border-top:2px dashed var(--danger);"></div>
                            <span>Dependency</span>
                        </div>
                    </div>
                `;
                area.classList.add('graph-container');

                const list = document.getElementById('people-list');
                list.innerHTML = '';

                // 1. Populate Sidebar List
                MEMBERS.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'member-card';
                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="font-weight:600; display:flex; align-items:center; gap:8px;">
                                ${m.type === 'AI' ? 'ü§ñ' : '<div class="avatar" style="width:20px;height:20px;font-size:9px;">' + m.avatar + '</div>'}
                                ${m.name}
                            </div>
                            <div style="font-size:11px; color:var(--text-secondary);">${m.role}</div>
                        </div>
                        <div style="font-size:11px; color:var(--text-secondary); display:flex; justify-content:space-between;">
                            <span>Capacity</span>
                            <div style="width:60px; height:4px; background:rgba(255,255,255,0.1); border-radius:2px; align-self:center;">
                                <div style="width:${Math.floor(Math.random() * 40 + 60)}%; height:100%; background:var(--success); border-radius:2px;"></div>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });

                const svg = area.querySelector('svg');
                const container = document.getElementById('nodes-container');

                // Robust Sizing
                const rect = area.getBoundingClientRect();
                const width = rect.width || 800; // Fallback
                const height = rect.height || 600;
                const cx = width / 2;
                const cy = height / 2;

                // Build Nodes
                let nodes = [];

                // A. Add Team Members (Circle Config)
                MEMBERS.forEach((m, i) => {
                    nodes.push({
                        id: m.id,
                        type: m.type === 'AI' ? 'agent' : 'person',
                        name: m.name,
                        x: cx + Math.cos(i / MEMBERS.length * Math.PI * 2) * 180,
                        y: cy + Math.sin(i / MEMBERS.length * Math.PI * 2) * 180,
                        vx: 0, vy: 0
                    });
                });

                // B. Add Tasks (Linked to Assignee)
                STATE.plan.forEach((t, i) => {
                    const assignee = nodes.find(n => n.id === t.assignee);
                    if (assignee) {
                        // Visual status color
                        let statusColor = 'var(--text-secondary)';
                        if (t.status === 'In Progress') statusColor = 'var(--accent-primary)';
                        if (t.status === 'Done') statusColor = 'var(--success)';

                        nodes.push({
                            id: t.id,
                            type: 'task',
                            title: t.title,
                            status: t.status,
                            statusColor: statusColor,
                            parent: assignee.id,
                            x: assignee.x + (Math.random() - 0.5) * 140,
                            y: assignee.y + (Math.random() - 0.5) * 140,
                            vx: 0, vy: 0
                        });
                    }
                });

                // C. Dependencies
                const dependencies = [
                    { from: 'T-102', to: 'T-105' } // Race Condition blocks Flaky Test
                ];

                // Member-Member Collaboration (Mocked)
                const collaborations = [
                    { from: 'u1', to: 'u2' }, // Dev to Dev
                    { from: 'u3', to: 'u4' }, // Frontend to QA
                    { from: 'u1', to: 'u3' }  // Staff to Frontend
                ];

                // Create DOM Elements
                nodes.forEach(n => {
                    const el = document.createElement('div');
                    el.className = `node node-${n.type}`;
                    el.id = `node-${n.id}`;

                    if (n.type === 'person') {
                        el.innerHTML = `
                            ${n.name === 'WarpSpeed' ? 'ü§ñ' : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>'}
                            <div class="node-label">${n.name}</div>
                        `;
                    } else if (n.type === 'agent') {
                        el.innerHTML = `ü§ñ<div class="node-label">${n.name}</div>`;
                    } else {
                        // Task
                        el.style.borderLeft = `3px solid ${n.statusColor}`;
                        el.innerHTML = `
                            <div style="font-weight:600; margin-bottom:2px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">${n.title}</div>
                            <div style="color:var(--text-secondary); font-size:10px; display:flex; justify-content:space-between;">
                                <span>${n.id}</span>
                                <span style="color:${n.statusColor}">${n.status}</span>
                            </div>
                        `;
                    }
                    container.appendChild(el);
                    n.el = el;
                });

                // Force Simulation
                const runSim = () => {
                    for (let iter = 0; iter < 80; iter++) {
                        // Forces
                        nodes.forEach(n1 => {
                            // Center Gravity (Stronger for stability)
                            const dx = cx - n1.x;
                            const dy = cy - n1.y;
                            n1.vx += dx * 0.003;
                            n1.vy += dy * 0.003;

                            // Repulsion
                            nodes.forEach(n2 => {
                                if (n1 === n2) return;
                                const dx = n1.x - n2.x;
                                const dy = n1.y - n2.y;
                                const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                                let force = 0;
                                // Increase repulsion for tasks to avoid overlap
                                if (n1.type === 'task' && n2.type === 'task') force = 4500 / (dist * dist);
                                else force = 12000 / (dist * dist);

                                n1.vx += (dx / dist) * force;
                                n1.vy += (dy / dist) * force;
                            });

                            // Link constraints (Parent-Child)
                            if (n1.type === 'task' && n1.parent) {
                                const p = nodes.find(n => n.id === n1.parent);
                                if (p) {
                                    const dx = p.x - n1.x;
                                    const dy = p.y - n1.y;
                                    n1.vx += dx * 0.06;
                                    n1.vy += dy * 0.06;
                                }
                            }
                        });

                        // Update Position
                        nodes.forEach(n => {
                            n.x += n.vx;
                            n.y += n.vy;
                            n.vx *= 0.85; // friction
                            n.vy *= 0.85;
                        });
                    }

                    // Render Final
                    svg.innerHTML = '';

                    // Render Collaborations (Bottom Layer)
                    collaborations.forEach(c => {
                        const fromNode = nodes.find(n => n.id === c.from);
                        const toNode = nodes.find(n => n.id === c.to);
                        if (fromNode && toNode) {
                            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            line.setAttribute('x1', fromNode.x);
                            line.setAttribute('y1', fromNode.y);
                            line.setAttribute('x2', toNode.x);
                            line.setAttribute('y2', toNode.y);
                            line.setAttribute('class', 'collaboration');
                            svg.appendChild(line);
                        }
                    });

                    // Render Connections
                    nodes.forEach(n => {
                        n.el.style.transform = `translate(${n.x - (n.type === 'task' ? 70 : 25)}px, ${n.y - (n.type === 'task' ? 25 : 25)}px)`;

                        if (n.type === 'task') {
                            const p = nodes.find(x => x.id === n.parent);
                            if (p) {
                                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                                line.setAttribute('x1', p.x);
                                line.setAttribute('y1', p.y);
                                line.setAttribute('x2', n.x);
                                line.setAttribute('y2', n.y);
                                line.setAttribute('class', 'connection');
                                svg.appendChild(line);
                            }
                        }
                    });

                    // Render Dependencies (Dashed Red Lines)
                    dependencies.forEach(dep => {
                        const fromNode = nodes.find(n => n.id === dep.from);
                        const toNode = nodes.find(n => n.id === dep.to);
                        if (fromNode && toNode) {
                            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            line.setAttribute('x1', fromNode.x);
                            line.setAttribute('y1', fromNode.y);
                            line.setAttribute('x2', toNode.x);
                            line.setAttribute('y2', toNode.y);
                            line.setAttribute('class', 'dependency');
                            svg.appendChild(line);
                        }
                    });
                };

                // Run immediately
                setTimeout(runSim, 50); // slight delay to ensure DOM is ready
            },

            renderData: () => {
                const el = document.getElementById('data-content');
                // Dashboard Logic

                // MOCK Metrics
                const velocity = STATE.scenario === 'PTO' ? 32 : (STATE.scenario === 'FLAKY' ? 28 : 45);
                const target = 48;
                const prodScore = Math.floor((velocity / target) * 100);

                const meetings = [
                    { name: 'Product Sync (Weekly)', time: 'Mon 9:00 AM', impact: 'High' },
                    { name: 'Eng Leadership Sync', time: 'Mon 1:00 PM', impact: 'Critical' },
                    { name: 'Security Audit Review', time: 'Tue 10:00 AM', impact: 'Blocker' }
                ];

                const demands = [
                    { from: 'VP Product', msg: 'Must ship "Login V2" this sprint' },
                    { from: 'SecOps', msg: 'Audit findings need patch T-112' }
                ];

                el.innerHTML = `
                    <div style="margin-bottom:20px;">
                        <h2 style="font-size:20px; font-weight:600; margin-bottom:8px;">Sprint 24 Data Dashboard</h2>
                        <div style="color:var(--text-secondary);">Transparency Report & Signal Analysis</div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <!-- Left Col: KPIs -->
                        <div style="display:flex; flex-direction:column; gap:20px;">
                            <div class="dash-card">
                                <h4>Productivity Projection</h4>
                                <div class="kpi-value">${prodScore}%</div>
                                <div class="kpi-sub">vs. 3-sprint average</div>
                                <div style="width:100%; height:4px; background:rgba(255,255,255,0.1); margin-top:10px; border-radius:2px;">
                                    <div style="width:${prodScore}%; height:100%; background:var(--accent-primary); border-radius:2px;"></div>
                                </div>
                            </div>
                            <div class="dash-card">
                                <h4>Planned Velocity</h4>
                                <div class="kpi-value">${velocity} <span style="font-size:16px; color:var(--text-secondary);">pts</span></div>
                                <div class="kpi-sub">Target: ${target} pts</div>
                            </div>
                            <div class="dash-card">
                                <h4>Team Sentiment</h4>
                                <div class="kpi-value" style="color:#36B37E">Positive</div>
                                <div class="kpi-sub">Based on Slack Emojis</div>
                            </div>
                        </div>

                        <!-- Mid Col: Signals -->
                        <div class="dash-card" style="grid-column: span 2;">
                            <h4>Input Signals & Context</h4>
                            
                            <h5 style="font-size:12px; margin-bottom:10px; color:#579DFF;">Transcribed Meetings</h5>
                            ${meetings.map(m => `
                                <div class="signal-item">
                                    <div>
                                        <div style="font-weight:500; color:var(--text-primary);">${m.name}</div>
                                        <div style="font-size:11px; color:var(--text-secondary);">${m.time}</div>
                                    </div>
                                    <span class="signal-tag">${m.impact}</span>
                                </div>
                            `).join('')}
                            
                            <h5 style="font-size:12px; margin:20px 0 10px 0; color:#FF5630;">Leadership Demands</h5>
                            ${demands.map(d => `
                                <div class="signal-item">
                                    <div style="display:flex; gap:10px;">
                                        <div style="font-weight:600; width:80px; color:var(--text-primary);">${d.from}</div>
                                        <div style="color:var(--text-secondary);">"${d.msg}"</div>
                                    </div>
                                </div>
                            `).join('')}

                             <h5 style="font-size:12px; margin:20px 0 10px 0; color:#FFAB00;">Capacity Constraints</h5>
                             <div class="signal-item">
                                <div>2 Team members on PTO next Friday (Diwali)</div>
                                <span class="signal-tag" style="background:rgba(255, 171, 0, 0.15); color:#FFAB00;">Capacity -10%</span>
                             </div>
                        </div>
                    </div>
                `;
            },

            updateData: (id, field, val) => {
                const idx = STATE.plan.findIndex(i => i.id === id);
                if (idx >= 0) STATE.plan[idx][field] = val;
            },

            // --- ACTION LOGIC ---
            approveSprint: () => {
                // Navigate to Kanban
                app.nav('kanban');
            },

            actionItem: (id, action) => {
                if (action === 'ignore') {
                    STATE.plan = STATE.plan.filter(i => i.id !== id);
                } else if (action === 'weight') {
                    const idx = STATE.plan.findIndex(i => i.id === id);
                    if (idx >= 0) STATE.plan[idx].points += 3;
                }
                app.renderPlan();
            },

            // --- CHAT LOGIC ---
            chatKey: (e) => {
                if (e.key === 'Enter') {
                    const val = mapChatIntent(e.target.value);
                    const hist = document.getElementById('chat-history');
                    hist.innerHTML += `<div class="chat-bubble user">${e.target.value}</div>`;
                    e.target.value = '';

                    // Respond
                    setTimeout(() => {
                        let resp = "I updated the plan.";
                        if (val.action === 'remove') {
                            STATE.plan = STATE.plan.filter(i => !i.title.toLowerCase().includes(val.target.toLowerCase()));
                            resp = "I removed that item from the sprint.";
                        } else if (val.action === 'assign') {
                            // Find member
                            const mem = MEMBERS.find(m => m.name.toLowerCase() === val.target.toLowerCase());
                            if (mem) {
                                // Assign last item to them (heuristic)
                                if (STATE.plan.length > 0) STATE.plan[0].assignee = mem.id;
                                resp = `Assigned the top priority item to ${mem.name}.`;
                            }
                        }

                        hist.innerHTML += `<div class="chat-bubble ai">${resp}</div>`;
                        app.renderPlan();
                    }, 500);
                }
            }
        };

        function mapChatIntent(text) {
            text = text.toLowerCase();
            if (text.includes('remove') || text.includes('drop')) {
                return { action: 'remove', target: text.replace('remove', '').replace('drop', '').trim() };
            }
            if (text.includes('assign')) {
                // simple parser: assign to Arjun
                const words = text.split(' ');
                const name = words[words.length - 1];
                return { action: 'assign', target: name };
            }
            return { action: 'unknown' };
        }
    </script>
</body>

</html>
